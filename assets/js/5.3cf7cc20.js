(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{373:function(t,s,a){t.exports=a.p+"assets/img/traces.957d11e8.png"},374:function(t,s,a){t.exports=a.p+"assets/img/logs-trace.7f585c6c.png"},375:function(t,s,a){t.exports=a.p+"assets/img/you_got_it_dude.267695dc.gif"},393:function(t,s,a){"use strict";a.r(s);var e=a(8),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"lab-3-integrating-an-app"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#lab-3-integrating-an-app"}},[t._v("#")]),t._v(" Lab 3 - Integrating an app")]),t._v(" "),e("p",[t._v("In the last laboratory, we will learn how to modify a existing application in order to work with Jaeger. To cover different implementations of "),e("a",{attrs:{href:"https://www.jaegertracing.io/docs/1.21/client-libraries/#supported-libraries",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jaeger Client"),e("OutboundLink")],1),t._v(", it has been selected "),e("a",{attrs:{href:"https://github.com/dvoitekh/kubernetes-microservices",target:"_blank",rel:"noopener noreferrer"}},[t._v("dvoitekh/kubernetes-microservices"),e("OutboundLink")],1),t._v(", a OSS "),e("em",[t._v("Simple Kubernetes-based app")]),t._v(", which contains 3 services:")]),t._v(" "),e("ol",[e("li",[e("a",{attrs:{href:"https://flask.palletsprojects.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Flask (Python)"),e("OutboundLink")],1),t._v(" microservice (management of applications' logs).")]),t._v(" "),e("li",[e("a",{attrs:{href:"http://sinatrarb.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Sinatra (Ruby)"),e("OutboundLink")],1),t._v(" microservice (OAuth server - user registration and login).")]),t._v(" "),e("li",[t._v("MongoDB")])]),t._v(" "),e("mermaid",[t._v("\ngraph TD\n    A[/Browser\\] --\x3e |users| F[flask-app];\n    A[/Browser\\] --\x3e |logs| F[flask-app];\n    A[/Browser\\] --\x3e |applications| F[flask-app];\n    A[/Browser\\] --\x3e |login| S[sinatra-app];\n    F[flask-app] --\x3e |check_login| S[sinatra-app];\n    S[sinatra-app] ---\x3e |find| M[(MongoDB)];\n    S[sinatra-app] ---\x3e |save| M[(MongoDB)];\n    F[flask-app] --\x3e |save| M[(MongoDB)];\n    F[flask-app] --\x3e |find| M[(MongoDB)];\n")]),t._v(" "),e("h2",{attrs:{id:"_1-install-the-application-as-is-in-k8s"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-install-the-application-as-is-in-k8s"}},[t._v("#")]),t._v(" 1. Install the application as is in K8s")]),t._v(" "),e("p",[t._v("Before anything else, we are going to install the application without any modification to check that works properly.")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("Clone the modified application repo:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/alvsanand/kubernetes-microservices\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" kubernetes-microservices\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Build "),e("strong",[t._v("flask-app")]),t._v(" Docker image and upload to minikube:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("eval")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("minikube docker-env"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\ndocker build -t flask-app flask-app\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Build "),e("strong",[t._v("sinatra-app")]),t._v(" Docker image and upload to minikube:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("docker build -t sinatra-app sinatra-app\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Install "),e("strong",[t._v("kubernetes-microservices")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl create namespace kubernetes-microservices\n\nkubectl apply -n kubernetes-microservices -f kubernetes/secrets.yml\n\nkubectl apply -n kubernetes-microservices -f kubernetes/mongo-deployment.yml\nkubectl apply -n kubernetes-microservices -f kubernetes/mongo-service.yml\n\nkubectl apply -n kubernetes-microservices -f kubernetes/flask-deployment.yml\nkubectl apply -n kubernetes-microservices -f kubernetes/flask-service.yml\n\nkubectl apply -n kubernetes-microservices -f kubernetes/sinatra-deployment.yml\nkubectl apply -n kubernetes-microservices -f kubernetes/sinatra-service.yml\n\nkubectl apply -n kubernetes-microservices -f kubernetes/ingress.yml\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Test the application:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("K8S_INGRESS_IP")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("kubectl get -n observability ingress -o "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("jsonpath")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{.items[0].status.loadBalancer.ingress[0].ip}'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("USER")])]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test_user"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("PASSWORD")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"very_scure_password"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("USER_CREDENTIALS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"username": "\'')]),e("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$USER")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'", "password": "\'')]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PASSWORD")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\"}'")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. Create user")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$USER_CREDENTIALS")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/users"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. Obtain JWT Token")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# CAUTION: jq command must be installed")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("JWT_TOKEN")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$USER_CREDENTIALS")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/login"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" jq -r "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.token'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. Create application")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"name": "test_app"}\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/applications"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. List applications")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/applications"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# 5. Add some logs to application "1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"ip_address": "1.2.3.4", "request": {"some_parameter_a": "some_value_a_1", "some_parameter_b": "some_value_b_1"}}\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/logs/1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"ip_address": "1.2.3.4", "request": {"some_parameter_a": "some_value_a_2", "some_parameter_b": "some_value_b_2"}}\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/logs/1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"ip_address": "1.2.3.4", "request": {"some_parameter_a": "some_value_a_3", "some_parameter_b": "some_value_b_3"}}\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/logs/1"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# 7. List logs of application "1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/logs/1"')])])])])]),t._v(" "),e("li",[e("p",[t._v("Delete the application resources:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl delete namespace kubernetes-microservices\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"_2-integrating-flask-app-with-jaeger"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-integrating-flask-app-with-jaeger"}},[t._v("#")]),t._v(" 2. Integrating flask-app with Jaeger")]),t._v(" "),e("p",[t._v("Firstly, "),e("code",[t._v("flask-app")]),t._v(" will be modified. Therefore, we will add the necessary code to application and the deployment configuration in order to work with Jaeger.")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("Add "),e("a",{attrs:{href:"https://pypi.org/project/Flask-OpenTracing/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Flask-OpenTracing"),e("OutboundLink")],1),t._v(" dependencies:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\nFlask-OpenTracing==1.1.0\njaeger-client==4.3.0'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" flask-app/requirements.txt   \n")])])])]),t._v(" "),e("li",[e("p",[t._v("Modify "),e("strong",[t._v("flask-app/config.py")]),t._v(" adding "),e("code",[t._v("JAEGER")]),t._v(" environment variables:")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[t._v("\nJAEGER_AGENT_HOST "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getenv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'JAEGER_AGENT_HOST'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'jaeger'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nJAEGER_AGENT_PORT "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getenv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'JAEGER_AGENT_PORT'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"6831"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Edit "),e("strong",[t._v("flask-app/app/views.py")]),t._v(" adding the Jaeger configuration to the Flask app:")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# Add this after line "from app.serializers import ApplicationSerializer, LogSerializer"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" jaeger_client "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Config\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" flask_opentracing "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" FlaskTracing\n\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("initialize_tracer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    config "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        config"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sampler'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'type'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'const'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'param'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'logging'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'local_agent'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'reporting_host'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config\n                 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'JAEGER_AGENT_HOST'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                 "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'reporting_port'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config\n                 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'JAEGER_AGENT_PORT'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        service_name"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"flask-app"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("initialize_tracer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\njaeger_tracer "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" initialize_tracer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntracing "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" FlaskTracing"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("jaeger_tracer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" trace_all_requests"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" app"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Modify "),e("strong",[t._v("kubernetes/flask-deployment.yml")]),t._v(" adding "),e("code",[t._v("JAEGER")]),t._v(" environment variables:")]),t._v(" "),e("div",{staticClass:"language-yml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# Add this after line "              value: "3000000""')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" JAEGER_AGENT_HOST\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" jaeger"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("workshop"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("agent.observability.svc.cluster.local\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" JAEGER_AGENT_PORT\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"6831"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"_3-integrating-sinatra-app-with-jaeger"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-integrating-sinatra-app-with-jaeger"}},[t._v("#")]),t._v(" 3. Integrating sinatra-app with Jaeger")]),t._v(" "),e("p",[t._v("Next, it is time to modify "),e("code",[t._v("simatra-app")]),t._v(", the Ruby service. We will also add the necessary code to application and the deployment configuration in order to work with Jaeger.")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("Add "),e("a",{attrs:{href:"https://github.com/salemove/jaeger-client-ruby",target:"_blank",rel:"noopener noreferrer"}},[t._v("jaeger-client-ruby"),e("OutboundLink")],1),t._v(" dependencies:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"\ngem 'jaeger-client'\ngem 'rack-tracer'\ngem 'opentracing'\n\"")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" sinatra-app/Gemfile   \n")])])])]),t._v(" "),e("li",[e("p",[t._v("Edit "),e("strong",[t._v("sinatra-app/app.rb")]),t._v(" adding the Jaeger configuration to the Ruby app:")]),t._v(" "),e("div",{staticClass:"language-rb extra-class"},[e("pre",{pre:!0,attrs:{class:"language-rb"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Add this after line \"require './mongoid'\"")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("require")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'jaeger/client'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("require")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'opentracing'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("require")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'rack/tracer'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Add this after line \"  set :port, ENV['APP_PORT']\"")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("OpenTracing")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("global_tracer "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Jaeger")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Client")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("build"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("host"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ENV")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'JAEGER_AGENT_HOST'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" port"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ENV")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'JAEGER_AGENT_PORT'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("to_i"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" service_name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sinatra-app'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  use "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Rack")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Tracer")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")])])])])]),t._v(" "),e("li",[e("p",[t._v("Modify "),e("strong",[t._v("kubernetes/sinatra-deployment.yml")]),t._v(" adding "),e("code",[t._v("JAEGER")]),t._v(" environment variables:")]),t._v(" "),e("div",{staticClass:"language-yml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# Add this after line "              value: "3000000""')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" JAEGER_AGENT_HOST\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" jaeger"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("workshop"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("agent.observability.svc.cluster.local\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" JAEGER_AGENT_PORT\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"6831"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"_4-propagating-the-tracing-http-headers"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-propagating-the-tracing-http-headers"}},[t._v("#")]),t._v(" 4. Propagating the tracing HTTP headers")]),t._v(" "),e("p",[t._v("Now, we are able to trace all requests from the Python and Ruby services. However, the requests made from "),e("code",[t._v("flask-app")]),t._v(" to "),e("code",[t._v("sinatra-app")]),t._v(" are not correlated because the span is not propagated. To solve that, we have to modify again "),e("code",[t._v("flask-app")]),t._v(" to do so.")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("Add "),e("a",{attrs:{href:"https://pypi.org/project/opentracing-instrumentation/",target:"_blank",rel:"noopener noreferrer"}},[t._v("opentracing-instrumentation"),e("OutboundLink")],1),t._v(" dependency:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\nopentracing-instrumentation===3.3.1\ntornado==5.1.1'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" flask-app/requirements.txt   \n")])])])]),t._v(" "),e("li",[e("p",[t._v("Edit "),e("strong",[t._v("flask-app/app/views.py")]),t._v(" adding the Jaeger configuration to the Flask app:")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# Add this after line "from flask_opentracing import FlaskTracing"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentracing_instrumentation"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client_hooks "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" install_all_patches\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# Add this after line "tracing = FlaskTracing(jaeger_tracer, trace_all_requests=True, app=app)"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\ninstall_all_patches"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"_5-adding-children-spans"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-adding-children-spans"}},[t._v("#")]),t._v(" 5. Adding children spans")]),t._v(" "),e("p",[t._v("There is only left one last change into the code. As we have seen earlier, it is very important to trace all services that could create bottlenecks in the system and our MongoDB database is our biggest candidate. Therefore, we are going to add children traces to "),e("code",[t._v("flask-app")]),t._v(" which will trace all the call to MongoDB.")]),t._v(" "),e("p",[t._v("This is the plan:")]),t._v(" "),e("ol",[e("li",[t._v("Create a decorator so we are able to trace every method of the class "),e("code",[t._v("app.modeles.BaseRecord")]),t._v(" which is a MongoDB wrapper class.")]),t._v(" "),e("li",[t._v("This decorator will create a child span with some information about the operation performed into MongoDB.")]),t._v(" "),e("li",[t._v("We will add the decorator to all methods of the class "),e("code",[t._v("app.modeles.BaseRecord")]),t._v(" that actually perform an operation to MonogoDB.")])]),t._v(" "),e("p",[t._v("Let`s go and edit "),e("strong",[t._v("flask-app/app/models.py")]),t._v(" adding the children spans to the MongoDB wrapper class:")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Add this after line \"                app.config['MONGO_PORT'])[app.config['MONGO_DB_NAME']]\"")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tracing_method_decorator")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("decorated_function"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" flask "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" request\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("trace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("args"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("views "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" jaeger_tracer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tracing\n\n            current_span "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tracing"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_span"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n            cls "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" args"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" jaeger_tracer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("start_span"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongodb'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" child_of"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("current_span"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \\\n                    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" child_span"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                child_span"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("set_tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongodb.collection'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cls"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("COLLECTION"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                child_span"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("set_tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongodb.operation'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                   decorated_function"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("__name__"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("except")]),t._v(" Exception "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Error while tracing method: {}"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("format")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" decorated_function"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("args"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" trace\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# Add this after lines "    @classmethod"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@tracing_method_decorator")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("######################################")]),t._v("\n")])])]),e("h2",{attrs:{id:"_6-installing-modified-version-of-the-application-in-k8s"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-installing-modified-version-of-the-application-in-k8s"}},[t._v("#")]),t._v(" 6. Installing modified version of the application in k8s")]),t._v(" "),e("p",[t._v("After all changes are performed, it is time to install again the application with the modifications.")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("Rebuild "),e("strong",[t._v("flask-app")]),t._v(" Docker image and upload to minikube:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("docker build -t flask-app flask-app\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Rebuild "),e("strong",[t._v("sinatra-app")]),t._v(" Docker image and upload to minikube:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("docker build -t sinatra-app sinatra-app\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Install "),e("strong",[t._v("kubernetes-microservices")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl create namespace kubernetes-microservices\n\nkubectl apply -n kubernetes-microservices -f kubernetes/secrets.yml\n\nkubectl apply -n kubernetes-microservices -f kubernetes/mongo-deployment.yml\nkubectl apply -n kubernetes-microservices -f kubernetes/mongo-service.yml\n\nkubectl apply -n kubernetes-microservices -f kubernetes/flask-deployment.yml\nkubectl apply -n kubernetes-microservices -f kubernetes/flask-service.yml\n\nkubectl apply -n kubernetes-microservices -f kubernetes/sinatra-deployment.yml\nkubectl apply -n kubernetes-microservices -f kubernetes/sinatra-service.yml\n\nkubectl apply -n kubernetes-microservices -f kubernetes/ingress.yml\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"_7-testing-the-application"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-testing-the-application"}},[t._v("#")]),t._v(" 7. Testing the application")]),t._v(" "),e("p",[t._v("Finally, let's go test the application and check Jaeger for the service traces.")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("Test the application:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("K8S_INGRESS_IP")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("kubectl get -n observability ingress -o "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("jsonpath")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{.items[0].status.loadBalancer.ingress[0].ip}'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("USER")])]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test_user"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("PASSWORD")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"very_scure_password"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("USER_CREDENTIALS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"username": "\'')]),e("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$USER")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'", "password": "\'')]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PASSWORD")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\"}'")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. Create user")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$USER_CREDENTIALS")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/users"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. Obtain JWT Token")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# CAUTION: jq command must be installed")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("JWT_TOKEN")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$USER_CREDENTIALS")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/login"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" jq -r "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.token'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3. Create application")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"name": "test_app"}\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/applications"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 4. List applications")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/applications"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# 5. Add some logs to application "1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"ip_address": "1.2.3.4", "request": {"some_parameter_a": "some_value_a_1", "some_parameter_b": "some_value_b_1"}}\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/logs/1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"ip_address": "1.2.3.4", "request": {"some_parameter_a": "some_value_a_2", "some_parameter_b": "some_value_b_2"}}\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/logs/1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"ip_address": "1.2.3.4", "request": {"some_parameter_a": "some_value_a_3", "some_parameter_b": "some_value_b_3"}}\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/logs/1"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# 7. List logs of application "1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization: Bearer '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${JWT_TOKEN}")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K8S_INGRESS_IP")]),t._v('/logs/1"')])])])])]),t._v(" "),e("li",[e("p",[t._v("Go to the "),e("strong",[t._v("Search")]),t._v(" page in the "),e("strong",[t._v("Jaeger UI")]),t._v(".")])]),t._v(" "),e("li",[e("p",[t._v("Select "),e("code",[t._v("flask-app")]),t._v(" in the "),e("strong",[t._v("Service")]),t._v(" drop-down list to filter the traces.")])]),t._v(" "),e("li",[e("p",[t._v("Click "),e("strong",[t._v("Find Traces")]),t._v(".\n"),e("img",{attrs:{src:a(373),alt:"Traces"}})])]),t._v(" "),e("li",[e("p",[t._v("Next, click in one of the "),e("code",[t._v("logs")]),t._v(" trace on the right side.\n"),e("img",{attrs:{src:a(374),alt:"Logs trace"}})])])]),t._v(" "),e("br"),t._v(" "),e("br"),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("This is the END!!!")]),t._v(" "),e("p",[t._v("You have reached the end of the workshop. I hope that you have now a good overview of "),e("a",{attrs:{href:"https://opentracing.io/docs/overview/what-is-tracing/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Distributed Tracing"),e("OutboundLink")],1),t._v(" and "),e("a",{attrs:{href:"https://www.jaegertracing.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jaeguer"),e("OutboundLink")],1),t._v(". For sure, you are more confident in being able to use tracing in your new developments.")]),t._v(" "),e("p",[t._v("Finally, I expect that you have enjoyed doing the different laboratories of this workshop because this was designed to do so.")]),t._v(" "),e("p",[e("em",[t._v("Thanks dude!")])]),t._v(" "),e("p",[e("img",{attrs:{src:a(375),alt:"Thanks dude"}})])])],1)}),[],!1,null,null,null);s.default=n.exports}}]);