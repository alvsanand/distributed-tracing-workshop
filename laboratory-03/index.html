<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 3 - Integrating an app | Distributed Tracing Workshop</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/distributed-tracing-workshop/favicon.ico">
    <meta name="description" content="Distributed Tracing Workshop">
    <meta property="og:site_name" content="Distributed Tracing Workshop">
    <meta property="og:title" content="Lab 3 - Integrating an app">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://alvsanand.github.io/distributed-tracing-workshop/laboratory-03/">
    <meta property="og:image" content="https://alvsanand.github.io/distributed-tracing-workshop/img/distributed-tracing_practice_preview.png">
    <meta name="twitter:title" content="Lab 3 - Integrating an app">
    <meta name="twitter:url" content="https://alvsanand.github.io/distributed-tracing-workshop/laboratory-03/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://alvsanand.github.io/distributed-tracing-workshop/img/distributed-tracing_practice_preview.png">
    
    <link rel="preload" href="/distributed-tracing-workshop/assets/css/0.styles.a19eab89.css" as="style"><link rel="preload" href="/distributed-tracing-workshop/assets/js/app.6775e0d1.js" as="script"><link rel="preload" href="/distributed-tracing-workshop/assets/js/2.c94d9c33.js" as="script"><link rel="preload" href="/distributed-tracing-workshop/assets/js/5.3cf7cc20.js" as="script"><link rel="preload" href="/distributed-tracing-workshop/assets/js/10.2d3ec1a6.js" as="script"><link rel="prefetch" href="/distributed-tracing-workshop/assets/js/11.41c785af.js"><link rel="prefetch" href="/distributed-tracing-workshop/assets/js/12.c4f0c58b.js"><link rel="prefetch" href="/distributed-tracing-workshop/assets/js/13.6cf10b4b.js"><link rel="prefetch" href="/distributed-tracing-workshop/assets/js/3.8ef80796.js"><link rel="prefetch" href="/distributed-tracing-workshop/assets/js/4.9a78ff1b.js"><link rel="prefetch" href="/distributed-tracing-workshop/assets/js/6.b08bc6e7.js"><link rel="prefetch" href="/distributed-tracing-workshop/assets/js/7.cf86b5a0.js"><link rel="prefetch" href="/distributed-tracing-workshop/assets/js/8.ba6d7404.js"><link rel="prefetch" href="/distributed-tracing-workshop/assets/js/9.424d0cce.js">
    <link rel="stylesheet" href="/distributed-tracing-workshop/assets/css/0.styles.a19eab89.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/distributed-tracing-workshop/" class="home-link router-link-active"><img src="/distributed-tracing-workshop/img/distributed-tracing_practice.png" alt="Distributed Tracing Workshop" class="logo"> <span class="site-name can-hide">Distributed Tracing Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/distributed-tracing-workshop/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="@alvsanand" class="dropdown-title"><span class="title">@alvsanand</span> <span class="arrow down"></span></button> <button type="button" aria-label="@alvsanand" class="mobile-dropdown-title"><span class="title">@alvsanand</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/alvsanand" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.linkedin.com/in/alvsanand/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LinekdIn
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://bluetab.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bluetab
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow down"></span></button> <button type="button" aria-label="Links" class="mobile-dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://opentracing.io/docs/overview/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  OpenTracing
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.jaegertracing.io/docs/latest" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Jaeger
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/distributed-tracing-workshop/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="@alvsanand" class="dropdown-title"><span class="title">@alvsanand</span> <span class="arrow down"></span></button> <button type="button" aria-label="@alvsanand" class="mobile-dropdown-title"><span class="title">@alvsanand</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/alvsanand" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.linkedin.com/in/alvsanand/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LinekdIn
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://bluetab.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bluetab
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow down"></span></button> <button type="button" aria-label="Links" class="mobile-dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://opentracing.io/docs/overview/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  OpenTracing
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.jaegertracing.io/docs/latest" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Jaeger
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/distributed-tracing-workshop/" aria-current="page" class="sidebar-link">Distributed Tracing Workshop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/#goals" class="sidebar-link">Goals</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/#index" class="sidebar-link">Index</a></li></ul></li><li><a href="/distributed-tracing-workshop/technical_overview/" class="sidebar-link">Technical Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/technical_overview/#what-is-distributed-tracing" class="sidebar-link">What is Distributed Tracing?</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/technical_overview/#why-should-we-use-it" class="sidebar-link">Why should we use it?</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/technical_overview/#opentracing" class="sidebar-link">OpenTracing</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/technical_overview/#jaeger" class="sidebar-link">Jaeger</a></li></ul></li><li><a href="/distributed-tracing-workshop/laboratory-01/" class="sidebar-link">Lab 1 - Installing Jaeger</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-01/#_1-installing-minikube" class="sidebar-link">1. Installing Minikube</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-01/#_2-starting-the-cluster" class="sidebar-link">2. Starting the cluster</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-01/#_3-interacting-with-k8s" class="sidebar-link">3. Interacting with K8s</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-01/#_4-deploying-a-sample-application" class="sidebar-link">4. Deploying a sample application</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-01/#_5-deleting-minikube-cluster" class="sidebar-link">5. Deleting minikube cluster</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-01/#_6-deploying-jaeger-operator" class="sidebar-link">6. Deploying Jaeger Operator</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-01/#_7-deploying-jaeger-instance" class="sidebar-link">7. Deploying Jaeger instance</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-01/#_8-validating-jaeger-deployment" class="sidebar-link">8. Validating Jaeger deployment</a></li></ul></li><li><a href="/distributed-tracing-workshop/laboratory-02/" class="sidebar-link">Lab 2 - Using Jaeger</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-02/#_1-installing-hotrod" class="sidebar-link">1. Installing HotROD</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-02/#_2-using-hotrod" class="sidebar-link">2. Using HotROD</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-02/#_3-understanding-the-data-flow-of-an-application" class="sidebar-link">3. Understanding the Data Flow of an application</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-02/#_4-searching-the-source-of-a-bottleneck" class="sidebar-link">4. Searching the source of a bottleneck</a></li></ul></li><li><a href="/distributed-tracing-workshop/laboratory-03/" aria-current="page" class="active sidebar-link">Lab 3 - Integrating an app</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-03/#_1-install-the-application-as-is-in-k8s" class="sidebar-link">1. Install the application as is in K8s</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-03/#_2-integrating-flask-app-with-jaeger" class="sidebar-link">2. Integrating flask-app with Jaeger</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-03/#_3-integrating-sinatra-app-with-jaeger" class="sidebar-link">3. Integrating sinatra-app with Jaeger</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-03/#_4-propagating-the-tracing-http-headers" class="sidebar-link">4. Propagating the tracing HTTP headers</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-03/#_5-adding-children-spans" class="sidebar-link">5. Adding children spans</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-03/#_6-installing-modified-version-of-the-application-in-k8s" class="sidebar-link">6. Installing modified version of the application in k8s</a></li><li class="sidebar-sub-header"><a href="/distributed-tracing-workshop/laboratory-03/#_7-testing-the-application" class="sidebar-link">7. Testing the application</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="lab-3-integrating-an-app"><a href="#lab-3-integrating-an-app" class="header-anchor">#</a> Lab 3 - Integrating an app</h1> <p>In the last laboratory, we will learn how to modify a existing application in order to work with Jaeger. To cover different implementations of <a href="https://www.jaegertracing.io/docs/1.21/client-libraries/#supported-libraries" target="_blank" rel="noopener noreferrer">Jaeger Client<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, it has been selected <a href="https://github.com/dvoitekh/kubernetes-microservices" target="_blank" rel="noopener noreferrer">dvoitekh/kubernetes-microservices<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, a OSS <em>Simple Kubernetes-based app</em>, which contains 3 services:</p> <ol><li><a href="https://flask.palletsprojects.com/" target="_blank" rel="noopener noreferrer">Flask (Python)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> microservice (management of applications' logs).</li> <li><a href="http://sinatrarb.com/" target="_blank" rel="noopener noreferrer">Sinatra (Ruby)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> microservice (OAuth server - user registration and login).</li> <li>MongoDB</li></ol> <div class="mermaid">
graph TD
    A[/Browser\] --&gt; |users| F[flask-app];
    A[/Browser\] --&gt; |logs| F[flask-app];
    A[/Browser\] --&gt; |applications| F[flask-app];
    A[/Browser\] --&gt; |login| S[sinatra-app];
    F[flask-app] --&gt; |check_login| S[sinatra-app];
    S[sinatra-app] ---&gt; |find| M[(MongoDB)];
    S[sinatra-app] ---&gt; |save| M[(MongoDB)];
    F[flask-app] --&gt; |save| M[(MongoDB)];
    F[flask-app] --&gt; |find| M[(MongoDB)];
</div> <h2 id="_1-install-the-application-as-is-in-k8s"><a href="#_1-install-the-application-as-is-in-k8s" class="header-anchor">#</a> 1. Install the application as is in K8s</h2> <p>Before anything else, we are going to install the application without any modification to check that works properly.</p> <ol><li><p>Clone the modified application repo:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/alvsanand/kubernetes-microservices

<span class="token builtin class-name">cd</span> kubernetes-microservices
</code></pre></div></li> <li><p>Build <strong>flask-app</strong> Docker image and upload to minikube:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>minikube docker-env<span class="token variable">)</span></span>

docker build -t flask-app flask-app
</code></pre></div></li> <li><p>Build <strong>sinatra-app</strong> Docker image and upload to minikube:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t sinatra-app sinatra-app
</code></pre></div></li> <li><p>Install <strong>kubernetes-microservices</strong>:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl create namespace kubernetes-microservices

kubectl apply -n kubernetes-microservices -f kubernetes/secrets.yml

kubectl apply -n kubernetes-microservices -f kubernetes/mongo-deployment.yml
kubectl apply -n kubernetes-microservices -f kubernetes/mongo-service.yml

kubectl apply -n kubernetes-microservices -f kubernetes/flask-deployment.yml
kubectl apply -n kubernetes-microservices -f kubernetes/flask-service.yml

kubectl apply -n kubernetes-microservices -f kubernetes/sinatra-deployment.yml
kubectl apply -n kubernetes-microservices -f kubernetes/sinatra-service.yml

kubectl apply -n kubernetes-microservices -f kubernetes/ingress.yml
</code></pre></div></li> <li><p>Test the application:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">K8S_INGRESS_IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get -n observability ingress -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.items[0].status.loadBalancer.ingress[0].ip}'</span><span class="token variable">)</span></span>

<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token string">&quot;test_user&quot;</span>
<span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token string">&quot;very_scure_password&quot;</span>
<span class="token assign-left variable">USER_CREDENTIALS</span><span class="token operator">=</span><span class="token string">'{&quot;username&quot;: &quot;'</span><span class="token environment constant">$USER</span><span class="token string">'&quot;, &quot;password&quot;: &quot;'</span><span class="token variable">$PASSWORD</span><span class="token string">'&quot;}'</span>

<span class="token comment"># 1. Create user</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">&quot;<span class="token variable">$USER_CREDENTIALS</span>&quot;</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/users&quot;</span>

<span class="token comment"># 2. Obtain JWT Token</span>
<span class="token comment"># CAUTION: jq command must be installed</span>
<span class="token assign-left variable">JWT_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -Ss -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">&quot;<span class="token variable">$USER_CREDENTIALS</span>&quot;</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/login&quot;</span> <span class="token operator">|</span> jq -r <span class="token string">'.token'</span><span class="token variable">)</span></span>

<span class="token comment"># 3. Create application</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{&quot;name&quot;: &quot;test_app&quot;}'</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/applications&quot;</span>

<span class="token comment"># 4. List applications</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/applications&quot;</span>

<span class="token comment"># 5. Add some logs to application &quot;1&quot;</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{&quot;ip_address&quot;: &quot;1.2.3.4&quot;, &quot;request&quot;: {&quot;some_parameter_a&quot;: &quot;some_value_a_1&quot;, &quot;some_parameter_b&quot;: &quot;some_value_b_1&quot;}}'</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/logs/1&quot;</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{&quot;ip_address&quot;: &quot;1.2.3.4&quot;, &quot;request&quot;: {&quot;some_parameter_a&quot;: &quot;some_value_a_2&quot;, &quot;some_parameter_b&quot;: &quot;some_value_b_2&quot;}}'</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/logs/1&quot;</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{&quot;ip_address&quot;: &quot;1.2.3.4&quot;, &quot;request&quot;: {&quot;some_parameter_a&quot;: &quot;some_value_a_3&quot;, &quot;some_parameter_b&quot;: &quot;some_value_b_3&quot;}}'</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/logs/1&quot;</span>

<span class="token comment"># 7. List logs of application &quot;1&quot;</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/logs/1&quot;</span></code></pre></div></li> <li><p>Delete the application resources:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl delete namespace kubernetes-microservices
</code></pre></div></li></ol> <h2 id="_2-integrating-flask-app-with-jaeger"><a href="#_2-integrating-flask-app-with-jaeger" class="header-anchor">#</a> 2. Integrating flask-app with Jaeger</h2> <p>Firstly, <code>flask-app</code> will be modified. Therefore, we will add the necessary code to application and the deployment configuration in order to work with Jaeger.</p> <ol><li><p>Add <a href="https://pypi.org/project/Flask-OpenTracing/" target="_blank" rel="noopener noreferrer">Flask-OpenTracing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> dependencies:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">echo</span> <span class="token string">'
Flask-OpenTracing==1.1.0
jaeger-client==4.3.0'</span> <span class="token operator">&gt;&gt;</span> flask-app/requirements.txt   
</code></pre></div></li> <li><p>Modify <strong>flask-app/config.py</strong> adding <code>JAEGER</code> environment variables:</p> <div class="language-py extra-class"><pre class="language-py"><code>
JAEGER_AGENT_HOST <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'JAEGER_AGENT_HOST'</span><span class="token punctuation">,</span> <span class="token string">'jaeger'</span><span class="token punctuation">)</span>
JAEGER_AGENT_PORT <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'JAEGER_AGENT_PORT'</span><span class="token punctuation">,</span> <span class="token string">&quot;6831&quot;</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>Edit <strong>flask-app/app/views.py</strong> adding the Jaeger configuration to the Flask app:</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token comment">######################################</span>
<span class="token comment"># Add this after line &quot;from app.serializers import ApplicationSerializer, LogSerializer&quot;</span>
<span class="token comment">######################################</span>
<span class="token keyword">from</span> jaeger_client <span class="token keyword">import</span> Config
<span class="token keyword">from</span> flask_opentracing <span class="token keyword">import</span> FlaskTracing


<span class="token keyword">def</span> <span class="token function">initialize_tracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    config <span class="token operator">=</span> Config<span class="token punctuation">(</span>
        config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'sampler'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'const'</span><span class="token punctuation">,</span> <span class="token string">'param'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">'logging'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                <span class="token string">'local_agent'</span><span class="token punctuation">:</span>
                <span class="token punctuation">{</span><span class="token string">'reporting_host'</span><span class="token punctuation">:</span> app<span class="token punctuation">.</span>config
                 <span class="token punctuation">[</span><span class="token string">'JAEGER_AGENT_HOST'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 <span class="token string">'reporting_port'</span><span class="token punctuation">:</span> app<span class="token punctuation">.</span>config
                 <span class="token punctuation">[</span><span class="token string">'JAEGER_AGENT_PORT'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        service_name<span class="token operator">=</span><span class="token string">&quot;flask-app&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> config<span class="token punctuation">.</span>initialize_tracer<span class="token punctuation">(</span><span class="token punctuation">)</span>


jaeger_tracer <span class="token operator">=</span> initialize_tracer<span class="token punctuation">(</span><span class="token punctuation">)</span>
tracing <span class="token operator">=</span> FlaskTracing<span class="token punctuation">(</span>jaeger_tracer<span class="token punctuation">,</span> trace_all_requests<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> app<span class="token operator">=</span>app<span class="token punctuation">)</span>
<span class="token comment">######################################</span>
</code></pre></div></li> <li><p>Modify <strong>kubernetes/flask-deployment.yml</strong> adding <code>JAEGER</code> environment variables:</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment">######################################</span>
<span class="token comment"># Add this after line &quot;              value: &quot;3000000&quot;&quot;</span>
<span class="token comment">######################################</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JAEGER_AGENT_HOST
              <span class="token key atrule">value</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>workshop<span class="token punctuation">-</span>agent.observability.svc.cluster.local
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JAEGER_AGENT_PORT
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;6831&quot;</span>
<span class="token comment">######################################</span>
</code></pre></div></li></ol> <h2 id="_3-integrating-sinatra-app-with-jaeger"><a href="#_3-integrating-sinatra-app-with-jaeger" class="header-anchor">#</a> 3. Integrating sinatra-app with Jaeger</h2> <p>Next, it is time to modify <code>simatra-app</code>, the Ruby service. We will also add the necessary code to application and the deployment configuration in order to work with Jaeger.</p> <ol><li><p>Add <a href="https://github.com/salemove/jaeger-client-ruby" target="_blank" rel="noopener noreferrer">jaeger-client-ruby<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> dependencies:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;
gem 'jaeger-client'
gem 'rack-tracer'
gem 'opentracing'
&quot;</span> <span class="token operator">&gt;&gt;</span> sinatra-app/Gemfile   
</code></pre></div></li> <li><p>Edit <strong>sinatra-app/app.rb</strong> adding the Jaeger configuration to the Ruby app:</p> <div class="language-rb extra-class"><pre class="language-rb"><code><span class="token comment">######################################</span>
<span class="token comment"># Add this after line &quot;require './mongoid'&quot;</span>
<span class="token comment">######################################</span>

<span class="token keyword">require</span> <span class="token string">'jaeger/client'</span>
<span class="token keyword">require</span> <span class="token string">'opentracing'</span>
<span class="token keyword">require</span> <span class="token string">'rack/tracer'</span>
<span class="token comment">######################################</span>

<span class="token comment">######################################</span>
<span class="token comment"># Add this after line &quot;  set :port, ENV['APP_PORT']&quot;</span>
<span class="token comment">######################################</span>

  <span class="token constant">OpenTracing</span><span class="token punctuation">.</span>global_tracer <span class="token operator">=</span> <span class="token constant">Jaeger</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Client</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span>host<span class="token punctuation">:</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'JAEGER_AGENT_HOST'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> port<span class="token punctuation">:</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'JAEGER_AGENT_PORT'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_i<span class="token punctuation">,</span> service_name<span class="token punctuation">:</span> <span class="token string">'sinatra-app'</span><span class="token punctuation">)</span>
  use <span class="token constant">Rack</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Tracer</span>
<span class="token comment">######################################</span></code></pre></div></li> <li><p>Modify <strong>kubernetes/sinatra-deployment.yml</strong> adding <code>JAEGER</code> environment variables:</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment">######################################</span>
<span class="token comment"># Add this after line &quot;              value: &quot;3000000&quot;&quot;</span>
<span class="token comment">######################################</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JAEGER_AGENT_HOST
              <span class="token key atrule">value</span><span class="token punctuation">:</span> jaeger<span class="token punctuation">-</span>workshop<span class="token punctuation">-</span>agent.observability.svc.cluster.local
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JAEGER_AGENT_PORT
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;6831&quot;</span>
<span class="token comment">######################################</span>
</code></pre></div></li></ol> <h2 id="_4-propagating-the-tracing-http-headers"><a href="#_4-propagating-the-tracing-http-headers" class="header-anchor">#</a> 4. Propagating the tracing HTTP headers</h2> <p>Now, we are able to trace all requests from the Python and Ruby services. However, the requests made from <code>flask-app</code> to <code>sinatra-app</code> are not correlated because the span is not propagated. To solve that, we have to modify again <code>flask-app</code> to do so.</p> <ol><li><p>Add <a href="https://pypi.org/project/opentracing-instrumentation/" target="_blank" rel="noopener noreferrer">opentracing-instrumentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> dependency:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">echo</span> <span class="token string">'
opentracing-instrumentation===3.3.1
tornado==5.1.1'</span> <span class="token operator">&gt;&gt;</span> flask-app/requirements.txt   
</code></pre></div></li> <li><p>Edit <strong>flask-app/app/views.py</strong> adding the Jaeger configuration to the Flask app:</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token comment">######################################</span>
<span class="token comment"># Add this after line &quot;from flask_opentracing import FlaskTracing&quot;</span>
<span class="token comment">######################################</span>
<span class="token keyword">from</span> opentracing_instrumentation<span class="token punctuation">.</span>client_hooks <span class="token keyword">import</span> install_all_patches
<span class="token comment">######################################</span>

<span class="token comment">######################################</span>
<span class="token comment"># Add this after line &quot;tracing = FlaskTracing(jaeger_tracer, trace_all_requests=True, app=app)&quot;</span>
<span class="token comment">######################################</span>
install_all_patches<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">######################################</span>
</code></pre></div></li></ol> <h2 id="_5-adding-children-spans"><a href="#_5-adding-children-spans" class="header-anchor">#</a> 5. Adding children spans</h2> <p>There is only left one last change into the code. As we have seen earlier, it is very important to trace all services that could create bottlenecks in the system and our MongoDB database is our biggest candidate. Therefore, we are going to add children traces to <code>flask-app</code> which will trace all the call to MongoDB.</p> <p>This is the plan:</p> <ol><li>Create a decorator so we are able to trace every method of the class <code>app.modeles.BaseRecord</code> which is a MongoDB wrapper class.</li> <li>This decorator will create a child span with some information about the operation performed into MongoDB.</li> <li>We will add the decorator to all methods of the class <code>app.modeles.BaseRecord</code> that actually perform an operation to MonogoDB.</li></ol> <p>Let`s go and edit <strong>flask-app/app/models.py</strong> adding the children spans to the MongoDB wrapper class:</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token comment">######################################</span>
<span class="token comment"># Add this after line &quot;                app.config['MONGO_PORT'])[app.config['MONGO_DB_NAME']]&quot;</span>
<span class="token comment">######################################</span>


<span class="token keyword">def</span> <span class="token function">tracing_method_decorator</span><span class="token punctuation">(</span>decorated_function<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> flask <span class="token keyword">import</span> request

    <span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">from</span> app<span class="token punctuation">.</span>views <span class="token keyword">import</span> jaeger_tracer<span class="token punctuation">,</span> tracing

            current_span <span class="token operator">=</span> tracing<span class="token punctuation">.</span>get_span<span class="token punctuation">(</span>request<span class="token punctuation">)</span>

            cls <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

            <span class="token keyword">with</span> jaeger_tracer<span class="token punctuation">.</span>start_span<span class="token punctuation">(</span><span class="token string">'mongodb'</span><span class="token punctuation">,</span> child_of<span class="token operator">=</span>current_span<span class="token punctuation">)</span> \
                    <span class="token keyword">as</span> child_span<span class="token punctuation">:</span>
                child_span<span class="token punctuation">.</span>set_tag<span class="token punctuation">(</span><span class="token string">'mongodb.collection'</span><span class="token punctuation">,</span> cls<span class="token punctuation">.</span>COLLECTION<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                child_span<span class="token punctuation">.</span>set_tag<span class="token punctuation">(</span><span class="token string">'mongodb.operation'</span><span class="token punctuation">,</span>
                                   decorated_function<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Error while tracing method: {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> decorated_function<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> trace
<span class="token comment">######################################</span>

<span class="token comment">######################################</span>
<span class="token comment"># Add this after lines &quot;    @classmethod&quot;</span>
<span class="token comment">######################################</span>
    <span class="token decorator annotation punctuation">@tracing_method_decorator</span>
<span class="token comment">######################################</span>
</code></pre></div><h2 id="_6-installing-modified-version-of-the-application-in-k8s"><a href="#_6-installing-modified-version-of-the-application-in-k8s" class="header-anchor">#</a> 6. Installing modified version of the application in k8s</h2> <p>After all changes are performed, it is time to install again the application with the modifications.</p> <ol><li><p>Rebuild <strong>flask-app</strong> Docker image and upload to minikube:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t flask-app flask-app
</code></pre></div></li> <li><p>Rebuild <strong>sinatra-app</strong> Docker image and upload to minikube:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t sinatra-app sinatra-app
</code></pre></div></li> <li><p>Install <strong>kubernetes-microservices</strong>:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl create namespace kubernetes-microservices

kubectl apply -n kubernetes-microservices -f kubernetes/secrets.yml

kubectl apply -n kubernetes-microservices -f kubernetes/mongo-deployment.yml
kubectl apply -n kubernetes-microservices -f kubernetes/mongo-service.yml

kubectl apply -n kubernetes-microservices -f kubernetes/flask-deployment.yml
kubectl apply -n kubernetes-microservices -f kubernetes/flask-service.yml

kubectl apply -n kubernetes-microservices -f kubernetes/sinatra-deployment.yml
kubectl apply -n kubernetes-microservices -f kubernetes/sinatra-service.yml

kubectl apply -n kubernetes-microservices -f kubernetes/ingress.yml
</code></pre></div></li></ol> <h2 id="_7-testing-the-application"><a href="#_7-testing-the-application" class="header-anchor">#</a> 7. Testing the application</h2> <p>Finally, let's go test the application and check Jaeger for the service traces.</p> <ol><li><p>Test the application:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">K8S_INGRESS_IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get -n observability ingress -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.items[0].status.loadBalancer.ingress[0].ip}'</span><span class="token variable">)</span></span>

<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token string">&quot;test_user&quot;</span>
<span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token string">&quot;very_scure_password&quot;</span>
<span class="token assign-left variable">USER_CREDENTIALS</span><span class="token operator">=</span><span class="token string">'{&quot;username&quot;: &quot;'</span><span class="token environment constant">$USER</span><span class="token string">'&quot;, &quot;password&quot;: &quot;'</span><span class="token variable">$PASSWORD</span><span class="token string">'&quot;}'</span>

<span class="token comment"># 1. Create user</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">&quot;<span class="token variable">$USER_CREDENTIALS</span>&quot;</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/users&quot;</span>

<span class="token comment"># 2. Obtain JWT Token</span>
<span class="token comment"># CAUTION: jq command must be installed</span>
<span class="token assign-left variable">JWT_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -Ss -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">&quot;<span class="token variable">$USER_CREDENTIALS</span>&quot;</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/login&quot;</span> <span class="token operator">|</span> jq -r <span class="token string">'.token'</span><span class="token variable">)</span></span>

<span class="token comment"># 3. Create application</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{&quot;name&quot;: &quot;test_app&quot;}'</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/applications&quot;</span>

<span class="token comment"># 4. List applications</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/applications&quot;</span>

<span class="token comment"># 5. Add some logs to application &quot;1&quot;</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{&quot;ip_address&quot;: &quot;1.2.3.4&quot;, &quot;request&quot;: {&quot;some_parameter_a&quot;: &quot;some_value_a_1&quot;, &quot;some_parameter_b&quot;: &quot;some_value_b_1&quot;}}'</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/logs/1&quot;</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{&quot;ip_address&quot;: &quot;1.2.3.4&quot;, &quot;request&quot;: {&quot;some_parameter_a&quot;: &quot;some_value_a_2&quot;, &quot;some_parameter_b&quot;: &quot;some_value_b_2&quot;}}'</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/logs/1&quot;</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{&quot;ip_address&quot;: &quot;1.2.3.4&quot;, &quot;request&quot;: {&quot;some_parameter_a&quot;: &quot;some_value_a_3&quot;, &quot;some_parameter_b&quot;: &quot;some_value_b_3&quot;}}'</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/logs/1&quot;</span>

<span class="token comment"># 7. List logs of application &quot;1&quot;</span>
<span class="token function">curl</span> -Ss -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${JWT_TOKEN}</span>&quot;</span> <span class="token string">&quot;http://<span class="token variable">$K8S_INGRESS_IP</span>/logs/1&quot;</span></code></pre></div></li> <li><p>Go to the <strong>Search</strong> page in the <strong>Jaeger UI</strong>.</p></li> <li><p>Select <code>flask-app</code> in the <strong>Service</strong> drop-down list to filter the traces.</p></li> <li><p>Click <strong>Find Traces</strong>.
<img src="/distributed-tracing-workshop/assets/img/traces.957d11e8.png" alt="Traces"></p></li> <li><p>Next, click in one of the <code>logs</code> trace on the right side.
<img src="/distributed-tracing-workshop/assets/img/logs-trace.7f585c6c.png" alt="Logs trace"></p></li></ol> <br> <br> <div class="custom-block tip"><p class="custom-block-title">This is the END!!!</p> <p>You have reached the end of the workshop. I hope that you have now a good overview of <a href="https://opentracing.io/docs/overview/what-is-tracing/" target="_blank" rel="noopener noreferrer">Distributed Tracing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://www.jaegertracing.io/" target="_blank" rel="noopener noreferrer">Jaeguer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. For sure, you are more confident in being able to use tracing in your new developments.</p> <p>Finally, I expect that you have enjoyed doing the different laboratories of this workshop because this was designed to do so.</p> <p><em>Thanks dude!</em></p> <p><img src="/distributed-tracing-workshop/assets/img/you_got_it_dude.267695dc.gif" alt="Thanks dude"></p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/distributed-tracing-workshop/laboratory-02/" class="prev">
        Lab 2 - Using Jaeger
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/distributed-tracing-workshop/assets/js/app.6775e0d1.js" defer></script><script src="/distributed-tracing-workshop/assets/js/2.c94d9c33.js" defer></script><script src="/distributed-tracing-workshop/assets/js/5.3cf7cc20.js" defer></script><script src="/distributed-tracing-workshop/assets/js/10.2d3ec1a6.js" defer></script>
  </body>
</html>
